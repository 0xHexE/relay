<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Persisted Queries · Relay</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="The relay compiler supports persisted queries which is useful because:"/><meta name="docsearch:version" content="v4.0.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Persisted Queries · Relay"/><meta property="og:type" content="website"/><meta property="og:url" content="https://relay.dev/"/><meta property="og:description" content="The relay compiler supports persisted queries which is useful because:"/><meta property="og:image" content="https://relay.dev/img/relay.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://relay.dev/img/relay.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-44373548-50', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="/js/redirect.js"></script><script type="text/javascript" src="/js/docsRating.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/en"><h2 class="headerTitle">Relay</h2></a><a href="/en/versions"><h3>v4.0.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/en/v4.0.0/introduction-to-relay" target="_self">Docs</a></li><li class=""><a href="/en/help" target="_self">Help</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><li class=""><a href="https://github.com/facebook/relay" target="_self">GitHub</a></li><li class=""><a target="_self"></a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Guides</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Introduction<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/introduction-to-relay">Introduction to Relay</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/prerequisites">Prerequisites</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/installation-and-setup">Installation and Setup</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/quick-start-guide">Quick Start Guide</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">API Reference<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/graphql-in-relay">GraphQL in Relay</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/relay-environment">Relay Environment</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/network-layer">Network Layer</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/query-renderer">QueryRenderer</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/fragment-container">Fragment Container</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/refetch-container">Refetch Container</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/pagination-container">Pagination Container</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/mutations">Mutations</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/subscriptions">Subscriptions</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/relay-store">Relay Store</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/fetch-query">fetchQuery</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Guides<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/routing">Routing</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/relay-debugging">Debugging</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/graphql-server-specification">GraphQL Server Specification</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/en/v4.0.0/persisted-queries">Persisted Queries</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/type-emission">Type Emission</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/testing-relay-components">Testing Relay Components</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/local-state-management">Local State Management</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Principles &amp; Architecture<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/thinking-in-graphql">Thinking in GraphQL</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/thinking-in-relay">Thinking In Relay</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/architecture-overview">Architecture Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/compiler-architecture">Compiler Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/runtime-architecture">Runtime Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/videos">Videos</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Community<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/v4.0.0/community-learning-resources">Community Learning Resources</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/facebook/relay/edit/master/docs/Modern-PersistedQueries.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Persisted Queries</h1></header><article><div><span><p>The relay compiler supports persisted queries which is useful because:</p>
<ul>
<li><p>the client operation text becomes just an md5 hash which is usually shorter than the real
query string. This saves upload bytes from the client to the server.</p></li>
<li><p>the server can now whitelist queries which improves security by restricting the operations
that can be executed by a client.</p></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="usage-on-the-client"></a><a href="#usage-on-the-client" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Usage on the client</h2>
<h3><a class="anchor" aria-hidden="true" id="the---persist-output-flag"></a><a href="#the---persist-output-flag" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The <code>--persist-output</code> flag</h3>
<p>In your <code>npm</code> script in <code>package.json</code>, run the relay compiler using the <code>--persist-output</code> flag:</p>
<pre><code class="hljs css language-js"><span class="hljs-string">&quot;scripts&quot;</span>: {
  <span class="hljs-string">&quot;relay&quot;</span>: <span class="hljs-string">&quot;relay-compiler --src ./src --schema ./schema.graphql --persist-output ./path/to/persisted-queries.json&quot;</span>
}
</code></pre>
<p>The <code>--persist-ouput</code> flag does 3 things:</p>
<ol>
<li><p>It converts all query and mutation operation texts to md5 hashes.</p>
<p>For example without <code>--persist-output</code>, a generated <code>ConcreteRequest</code> might look like below:</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> node<span class="hljs-comment">/*: ConcreteRequest*/</span> = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
<span class="hljs-comment">//... excluded for brevity</span>
<span class="hljs-keyword">return</span> {
  <span class="hljs-string">&quot;kind&quot;</span>: <span class="hljs-string">&quot;Request&quot;</span>,
  <span class="hljs-string">&quot;operationKind&quot;</span>: <span class="hljs-string">&quot;query&quot;</span>,
  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;TodoItemRefetchQuery&quot;</span>,
  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> id is null</span>
  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;query TodoItemRefetchQuery(\n  $itemID: ID!\n) {\n  node(id: $itemID) {\n    ...TodoItem_item_2FOrhs\n  }\n}\n\nfragment TodoItem_item_2FOrhs on Todo {\n    text\n    isComplete\n}\n&quot;</span>,
  <span class="hljs-comment">//... excluded for brevity</span>
};
})();
</code></pre>
<p>With <code>--persist-output &lt;path&gt;</code> this becomes:</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> node<span class="hljs-comment">/*: ConcreteRequest*/</span> = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
<span class="hljs-comment">//... excluded for brevity</span>
<span class="hljs-keyword">return</span> {
  <span class="hljs-string">&quot;kind&quot;</span>: <span class="hljs-string">&quot;Request&quot;</span>,
  <span class="hljs-string">&quot;operationKind&quot;</span>: <span class="hljs-string">&quot;query&quot;</span>,
  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;TodoItemRefetchQuery&quot;</span>,
  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;3be4abb81fa595e25eb725b2c6a87508&quot;</span>, <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> id is now an md5 hash of the query text</span>
  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> text is null now</span>
  <span class="hljs-comment">//... excluded for brevity</span>
};
})();
</code></pre></li>
<li><p>It generates a JSON file at the <code>&lt;path&gt;</code> you specify containing a mapping from query ids
to the corresponding operation texts.</p></li>
</ol>
<pre><code class="hljs css language-js"><span class="hljs-string">&quot;scripts&quot;</span>: {
  <span class="hljs-string">&quot;relay&quot;</span>: <span class="hljs-string">&quot;relay-compiler --src ./src --schema ./schema.graphql --persist-output ./src/queryMaps/queryMap.json&quot;</span>
}
</code></pre>
<p>The example above writes the complete query map file to <code>./src/queryMaps/queryMap.json</code>. You need to ensure all the directories
leading to the <code>queryMap.json</code> file exist.</p>
<h3><a class="anchor" aria-hidden="true" id="network-layer-changes"></a><a href="#network-layer-changes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Network layer changes</h3>
<p>You'll need to modify your network layer fetch implementation to pass a documentId parameter in the POST body instead of a query parameter:</p>
<pre><code class="hljs css language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchQuery</span>(<span class="hljs-params">operation, variables,</span>) </span>{
  <span class="hljs-keyword">return</span> fetch(<span class="hljs-string">&#x27;/graphql&#x27;</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">&#x27;content-type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify({
      <span class="hljs-attr">documentId</span>: operation.id, <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> pass md5 hash to the server</span>
      <span class="hljs-comment">// query: operation.text, // this is now obsolete because text is null</span>
      variables,
    }),
  }).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> response.json();
  });
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="executing-persisted-queries-on-the-server"></a><a href="#executing-persisted-queries-on-the-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Executing Persisted Queries on the Server</h2>
<p>To execute client requests that send persisted queries instead of query text, your server will need to be able
to lookup the query text corresponding to each id. Typically this will involve saving the output of the <code>--persist-output &lt;path&gt;</code> JSON file to a database or some other storage mechanism, and retrieving the corresponding text for the ID specified by a client.</p>
<p>For universal applications where the client and server code are in one project, this is not an issue since you can place
the query map file in a common location accessible to both the client and the server.</p>
<h3><a class="anchor" aria-hidden="true" id="compile-time-push"></a><a href="#compile-time-push" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compile time push</h3>
<p>For applications where the client and server projects are separate, one option is to have an additional npm run script
to push the query map at compile time to a location accessible by your server:</p>
<pre><code class="hljs css language-js"><span class="hljs-string">&quot;scripts&quot;</span>: {
  <span class="hljs-string">&quot;push-queries&quot;</span>: <span class="hljs-string">&quot;node ./pushQueries.js&quot;</span>,
  <span class="hljs-string">&quot;relay&quot;</span>: <span class="hljs-string">&quot;relay-compiler --src ./src --schema ./schema.graphql --persist-ouput &lt;path&gt; &amp;&amp; npm run push-queries&quot;</span>
}
</code></pre>
<p>Some possibilities of what you can do in <code>./pushQueries.js</code>:</p>
<ul>
<li><p><code>git push</code> to your server repo</p></li>
<li><p>save the query maps to a database</p></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="run-time-push"></a><a href="#run-time-push" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Run time push</h3>
<p>A second more complex option is to push your query maps to the server at runtime, without the server knowing the query ids at the start.
The client optimistically sends a query id to the server, which does not have the query map. The server then in turn requests
for the full query text from the client so it can cache the query map for subsequent requests. This is a more complex approach
requiring the client and server to interact to exchange the query maps.</p>
<h3><a class="anchor" aria-hidden="true" id="simple-server-example"></a><a href="#simple-server-example" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Simple server example</h3>
<p>Once your server has access to the query map, you can perform the mapping. The solution varies depending on the server and
database technologies you use, so we'll just cover the most common and basic example here.</p>
<p>If you use <code>express-graphql</code> and have access to the query map file, you can import the <code>--persist-output</code> JSON file directly and
perform the matching using the <code>matchQueryMiddleware</code> from <a href="https://github.com/yusinto/relay-compiler-plus">relay-compiler-plus</a>.</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">import</span> Express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;
<span class="hljs-keyword">import</span> expressGraphql <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express-graphql&#x27;</span>;
<span class="hljs-keyword">import</span> {matchQueryMiddleware} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;relay-compiler-plus&#x27;</span>;
<span class="hljs-keyword">import</span> queryMapJson <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./path/to/persisted-queries.json&#x27;</span>;

<span class="hljs-keyword">const</span> app = Express();

app.use(<span class="hljs-string">&#x27;/graphql&#x27;</span>,
  matchQueryMiddleware(queryMapJson),
  expressGraphl({schema}));
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="using---persist-output-and---watch"></a><a href="#using---persist-output-and---watch" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using <code>--persist-output</code> and <code>--watch</code></h2>
<p>It is possible to continuously generate the query map files by using the <code>--persist-output</code> and <code>--watch</code> options simultaneously.
This only makes sense for universal applications i.e. if your client and server code are in a single project
and you run them both together on localhost during development. Furthermore, in order for the server to pick up changes
to the <code>queryMap.json</code>, you'll need to have server side hot-reloading set up. The details on how to set this up
is out of the scope of this document.</p>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 1/3/2019 by Yusinto Ngadiman</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/en/v4.0.0/graphql-server-specification"><span class="arrow-prev">← </span><span class="function-name-prevnext">GraphQL Server Specification</span></a><a class="docs-next button" href="/docs/en/v4.0.0/type-emission"><span>Type Emission</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#usage-on-the-client">Usage on the client</a><ul class="toc-headings"><li><a href="#the---persist-output-flag">The <code>--persist-output</code> flag</a></li><li><a href="#network-layer-changes">Network layer changes</a></li></ul></li><li><a href="#executing-persisted-queries-on-the-server">Executing Persisted Queries on the Server</a><ul class="toc-headings"><li><a href="#compile-time-push">Compile time push</a></li><li><a href="#run-time-push">Run time push</a></li><li><a href="#simple-server-example">Simple server example</a></li></ul></li><li><a href="#using---persist-output-and---watch">Using <code>--persist-output</code> and <code>--watch</code></a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><div class="left-column"><div class="docsRating" id="docsRating">Is this page useful?<svg class="i_thumbsup" alt="Like" id="docsRating-like" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 81.13 89.76"><path d="M22.9 6a18.57 18.57 0 002.67 8.4 25.72 25.72 0 008.65 7.66c3.86 2 8.67 7.13 13.51 11 3.86 3.11 8.57 7.11 11.54 8.45s13.59.26 14.64 1.17c1.88 1.63 1.55 9-.11 15.25-1.61 5.86-5.96 10.55-6.48 16.86-.4 4.83-2.7 4.88-10.93 4.88h-1.35c-3.82 0-8.24 2.93-12.92 3.62a68 68 0 01-9.73.5c-3.57 0-7.86-.08-13.25-.08-3.56 0-4.71-1.83-4.71-4.48h8.42a3.51 3.51 0 000-7H12.28a2.89 2.89 0 01-2.88-2.88 1.91 1.91 0 01.77-1.78h16.46a3.51 3.51 0 000-7H12.29c-3.21 0-4.84-1.83-4.84-4a6.41 6.41 0 011.17-3.78h19.06a3.5 3.5 0 100-7H9.75A3.51 3.51 0 016 42.27a3.45 3.45 0 013.75-3.48h13.11c5.61 0 7.71-3 5.71-5.52-4.43-4.74-10.84-12.62-11-18.71-.15-6.51 2.6-7.83 5.36-8.56m0-6a6.18 6.18 0 00-1.53.2c-6.69 1.77-10 6.65-9.82 14.5.08 5.09 2.99 11.18 8.52 18.09H9.74a9.52 9.52 0 00-6.23 16.9 12.52 12.52 0 00-2.07 6.84 9.64 9.64 0 003.65 7.7 7.85 7.85 0 00-1.7 5.13 8.9 8.9 0 005.3 8.13 6 6 0 00-.26 1.76c0 6.37 4.2 10.48 10.71 10.48h13.25a73.75 73.75 0 0010.6-.56 35.89 35.89 0 007.58-2.18 17.83 17.83 0 014.48-1.34h1.35c4.69 0 7.79 0 10.5-1 3.85-1.44 6-4.59 6.41-9.38.2-2.46 1.42-4.85 2.84-7.62a41.3 41.3 0 003.42-8.13 48 48 0 001.59-10.79c.1-5.13-1-8.48-3.35-10.55-2.16-1.87-4.64-1.87-9.6-1.88a46.86 46.86 0 01-6.64-.29c-1.92-.94-5.72-4-8.51-6.3l-1.58-1.28c-1.6-1.3-3.27-2.79-4.87-4.23-3.33-3-6.47-5.79-9.61-7.45a20.2 20.2 0 01-6.43-5.53 12.44 12.44 0 01-1.72-5.36 6 6 0 00-6-5.86z"></path></svg><svg class="i_thumbsdown" alt="Dislike" id="docsRating-dislike" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 81.13 89.76"><path d="M22.9 6a18.57 18.57 0 002.67 8.4 25.72 25.72 0 008.65 7.66c3.86 2 8.67 7.13 13.51 11 3.86 3.11 8.57 7.11 11.54 8.45s13.59.26 14.64 1.17c1.88 1.63 1.55 9-.11 15.25-1.61 5.86-5.96 10.55-6.48 16.86-.4 4.83-2.7 4.88-10.93 4.88h-1.35c-3.82 0-8.24 2.93-12.92 3.62a68 68 0 01-9.73.5c-3.57 0-7.86-.08-13.25-.08-3.56 0-4.71-1.83-4.71-4.48h8.42a3.51 3.51 0 000-7H12.28a2.89 2.89 0 01-2.88-2.88 1.91 1.91 0 01.77-1.78h16.46a3.51 3.51 0 000-7H12.29c-3.21 0-4.84-1.83-4.84-4a6.41 6.41 0 011.17-3.78h19.06a3.5 3.5 0 100-7H9.75A3.51 3.51 0 016 42.27a3.45 3.45 0 013.75-3.48h13.11c5.61 0 7.71-3 5.71-5.52-4.43-4.74-10.84-12.62-11-18.71-.15-6.51 2.6-7.83 5.36-8.56m0-6a6.18 6.18 0 00-1.53.2c-6.69 1.77-10 6.65-9.82 14.5.08 5.09 2.99 11.18 8.52 18.09H9.74a9.52 9.52 0 00-6.23 16.9 12.52 12.52 0 00-2.07 6.84 9.64 9.64 0 003.65 7.7 7.85 7.85 0 00-1.7 5.13 8.9 8.9 0 005.3 8.13 6 6 0 00-.26 1.76c0 6.37 4.2 10.48 10.71 10.48h13.25a73.75 73.75 0 0010.6-.56 35.89 35.89 0 007.58-2.18 17.83 17.83 0 014.48-1.34h1.35c4.69 0 7.79 0 10.5-1 3.85-1.44 6-4.59 6.41-9.38.2-2.46 1.42-4.85 2.84-7.62a41.3 41.3 0 003.42-8.13 48 48 0 001.59-10.79c.1-5.13-1-8.48-3.35-10.55-2.16-1.87-4.64-1.87-9.6-1.88a46.86 46.86 0 01-6.64-.29c-1.92-.94-5.72-4-8.51-6.3l-1.58-1.28c-1.6-1.3-3.27-2.79-4.87-4.23-3.33-3-6.47-5.79-9.61-7.45a20.2 20.2 0 01-6.43-5.53 12.44 12.44 0 01-1.72-5.36 6 6 0 00-6-5.86z"></path></svg></div><div><a href="/" class="nav-home"><img src="/img/relay.svg" alt="Relay" width="66" height="58"/></a><div class="links-column"><h5>Docs</h5><a href="/docs/en/introduction-to-relay.html">Introduction</a></div></div></div><div><h5>Community</h5><a href="/en/users.html">User Showcase</a></div><div><h5>More</h5><a href="https://github.com/facebook/relay">GitHub</a><a href="https://opensource.facebook.com/legal/terms">Terms of Use</a><a href="https://opensource.facebook.com/legal/privacy">Privacy Policy</a><a href="https://opensource.facebook.com/legal/data-policy/">Data Policy</a><a href="https://opensource.facebook.com/legal/cookie-policy/">Cookie Policy</a></div></section><a href="https://code.facebook.com/projects/" target="_blank" class="fbOpenSource"><img src="/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2021 Facebook Inc.</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '3d7d5825d50ea36bca0e6ad06c926f06',
                indexName: 'relay',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["version:v4.0.0"]}
              });
            </script></body></html>